<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>JMS</title>
</head>
<body>

#每一行都由#号开始，只能包含JS
\#function ==> #function
#else if ==>elseif
#end if ==> }

##注释

##解决原版script的问题
#{
var a=new Date();
var c=hello;
echo("hello world");
if($!item indexOf()>0){
echo "
<li>hello world</li>
";
}
#}

<textarea name="" id="a" cols="90" rows="16">
    ##注释代码不可靠呢
    ##\#不应该出现
    #each
    <UL>


        ## if (true)
        ## var abc=123
        <li class="index#{(index+1)}">姓名： #{ name} 姓名长度：#{decodeURIComponent(name).length}</li>
        ## elseif ( msg == "hello world")
        ##
        ##
        <li><h2>当前时间#{(new Date).toLocaleTimeString()}</h2></li>
        <li class="#{age}">#{ age }</li>
        ##elseif (foo=123)
        <li class="none">$abc</li>
        ##else
        ##
        ##
        ##
        <li class="none">#{name.length}</li>
        ##endif
        ##var a=123;
        ##function hello(){

        ##}


    </UL>

    #end

</textarea>


<pre id="b">

</pre>
<script type="text/javascript">
    var a = document.getElementById('a');
    var b = document.getElementById('b');
    var encode = encodeURIComponent;

    //var arr = a.value.match(/[^\\]?#[a-z]+[^#\r\n]*/gmi);
    var htmlTpl = a.value.split(/$/gmi);

    var literal = /#\{([^\}]+)\}/gmi;

    var html = [];
    var template = [];

    function echo(str) {
        var literalResult = str.match(literal);
        if (literalResult) {
            literalResult.forEach(function (r) {
                template.push("html.push('" + encodeURIComponent(str.substring(0, str.indexOf(r))) + "')");
                template.push("html.push((function(){ return " + r.match(/{([^}]+)\}/)[1] + "  })( ))");
                str = str.substring(str.indexOf(r) + r.length);
            });

        } else {
            template.push("html.push('" + encodeURIComponent(str) + "')");
        }
    }

    var jsondata = {
        data:[
            {
                name:"张三",
                age:23,
                msg:"四川的人儿<b>啊啊啊啊</b>"
            },
            {
                name:"李四",
                age:66,
                msg:"敏感词"
            }
        ]};


    template.push('var jsondata=');
    template.push('{"data":[{"name":"熊松松","age":23,"msg":"四川的人儿<b>啊啊啊啊</b>"},{"name":"胡锦涛","age":66,"msg":"中华人民共和国的主席"}]}');

    var keyArr = Object.keys(jsondata.data[0]);

    keyArr.forEach(function (key) {
        template.push('var ' + key + ';');
    });

    htmlTpl.forEach(function (item, index) {
        var comment = /^[\s]*##/;
        var escape = /^[\s]*[\\]+[\s]*(#[\s\S]*)/;
        //JMS注释
        if (comment.test(item)) return;

        //转义
        if (escape.test(item)) {
            template.push(RegExp.$1);
            return
        }

        //优先替换script


        var _item = item.match(/^[\s]*#[\s]*(each|if|elseif|else|endif|end)((.)*)$/);
        if (_item) {
            switch (RegExp.$1) {
                case 'each':
                    template.push('jsondata.data.forEach(function(item,index,arr){');
                    keyArr.forEach(function (key) {
                        template.push('var ' + key + '=encodeURIComponent(item["' + key + '"])');
                    });
                    break;
                case 'if':
                    template.push(RegExp.$1 + RegExp.$2 + '{');
                    break;
                case 'elseif':
                    template.push('}else if' + RegExp.$2 + '{');
                    break;
                case 'else':
                    template.push('}else{');
                    break;
                case 'endif':
                    template.push('}');
                    break;
                case 'end':
                    template.push('})');
                    break;

            }
        } else {
            echo(item);
        }
    });

    template.push('alert(decodeURIComponent(html.join("")))');
    eval(template.join('\r\n'));


</script>
</body>
</html>
