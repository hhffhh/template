<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>JMS</title>
    <script type="text/javascript" src="jquery.1.8.2.js"></script>
</head>
<body>
<textarea id="text" cols="90" rows="20">
    <cms:text hello="world" group="123">
        <ul>
            <li>#{text}</li>
        </ul>
    </cms:text>
</textarea>
<!--

<script type="text/javascript">

    function getCMSTag() {
        var tag = $('#text').val().match(/<(cms:[^\s]+)(.*)*(group="[^"]+")/gmi);
        console.log(RegExp.$1, RegExp.$2, RegExp.$3)
    }
    getCMSTag();


    if (true > -1) {
        alert(false)
        if (false < 2) {
            alert(123)
        }
    }






</script>-->

#if(true)
#if(false)
#end
#end

<!--TODO:行内.属性获值不正确的问题，例如.length-->
<textarea name="" id="a" cols="90" rows="16">
    <UL>

        ＃ＩＦ(2>1)
        hello
        ＃ＥＮＤＩＦ


        ＃ＥＡＣＨ

        <li
        ＃ＩＦ(age>=88)
class="99"
        ＃ＥＮＤＩＦ
        #{name}</li>

        ＃ＥＮＤＥＡＣＨ

        #end
        #end #if \#end

    </UL>
</textarea>


<pre id="b">

</pre>
<script type="text/javascript">
    var a = document.getElementById('a');
    var b = document.getElementById('b');
    var encode = encodeURIComponent;

    //var arr = a.value.match(/[^\\]?#[a-z]+[^#\r\n]*/gmi);
    var htmlTpl = a.value.split(/$/gmi);

    var literal = /[\\]?#\{([^\}]+)\}/gmi;

    var html = [];
    var template = [];

    function echo(str) {
        var literalResult = str.match(literal);
        if (literalResult) {
            literalResult.forEach(function (r, index) {
                template.push("html.push('" + encodeURIComponent(str.substring(0, str.indexOf(r))) + "')");
                var variable = r.match(/{([^}]+)\}/)[1];
                //假设用户对一个不存在的变量进行
                if (r.indexOf('\\') > -1) {
                    template.push("html.push('" + encodeURIComponent(r.substring(r.indexOf('\\') + 1)) + "')");
                } else {
                    template.push("html.push((function(){ return typeof (" + variable + ")!=='undefined' ? " + variable + ":''  })( ))");
                }
                str = str.substring(str.indexOf(r) + r.length);
                if (index == literalResult.length - 1 && str.length > 0) {
                    template.push("html.push('" + encodeURIComponent(str) + "')")
                }
            });
        } else {
            if (str.trim().length > 0) template.push("html.push('" + encodeURIComponent(str) + "')");
        }
    }

    var jsondata = {
        data:[
            {
                name:"<b>王恺放</b>",
                age:23,
                msg:"四川的人儿<b>啊啊啊啊</b>"
            },
            {
                name:"李四",
                age:66,
                msg:"敏感词"
            },
            {
                name:"王五",
                age:88,
                msg:"敏感词"
            },

            {
                name:"六六",
                age:99,
                msg:"敏感词"
            }
        ]};


    template.push('var jsondata=');
    template.push('' + JSON.stringify(jsondata) + '');

    var keyArr = Object.keys(jsondata.data[0]);

    keyArr.forEach(function (key) {
        template.push('var ' + key + ';');
    });

    htmlTpl.forEach(function (item, index) {
        var comment = /^[\s]*##/;
        var escape = /^[\s]*[\\]+[\s]*(#[\s\S]*)/;
        //JMS注释
        if (comment.test(item)) return;

        //转义
        if (escape.test(item)) {
            template.push(RegExp.$1);
            return
        }

        //优先替换script


        var _item = item.match(/^[\s]*(＃ＩＦ|＃ＥＡＣＨ|＃ＥＮＤＩＦ|＃ＥＮＤＥＡＣＨ)(.*)$/);
        if (_item) {
            switch (RegExp.$1) {
                case '＃ＥＡＣＨ':
                    template.push('jsondata.data.forEach(function(item,index,arr){');
                    keyArr.forEach(function (key) {
                        template.push('var ' + key + '=encodeURIComponent(item["' + key + '"])');
                    });
                    //魔术变量
                    template.push('var first =  (index == 0)');
                    template.push('var last = (index == arr.length - 1)');
                    template.push('var odd = (index % 2 == 0)');
                    break;
                case '＃ＩＦ':
                    template.push('if' + RegExp.$2 + '{');
                    break;
                case '＃ＥＮＤＩＦ':
                    template.push('}');
                    break;
                case '＃ＥＮＤＥＡＣＨ':
                    template.push('})');
                    break;
            }
        } else {
            echo(item);
        }
    });

    template.push('alert(decodeURIComponent(html.join("")))');
    eval(template.join('\r'));

</script>
</body>
</html>
