<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Analysis label pairing</title>
    <script type="text/javascript" src="/jshint.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        pre, textarea {
            display: inline-block;
            width: 31%;
            vertical-align: top;
            height: 300px;
            border: solid 1px #aaa;
            background: #333;
            color: #fff;
            padding: 1em;
            margin: 0;
            font-family: Consolas, sans-serif;
            font-size: 12px;
        }
    </style>
</head>
<body>

<h1>Analysis label pairing</h1>

<p></p>
<textarea id="test" cols="60" rows="10">
    <h1>测试</h1>

    <h2 class="#if(1>2)A#elseif(2>3)B#elseif(2>1)C#elseD#end"></h2>
    <ul>
        #if(1>0)不参与运算()测()试
        <li>一大于零</li>
        #elseif(2>1)
        1\#elseif(111>111)2
        <li>二大于一</li>
        #else
        <li>最后的分支</li>
        #end
    </ul>
    <p>#{length}</p>

    #js
    var a=123;
    var c=123;
    #end
</textarea>

<textarea id="b" style="width: 20%">

</textarea>

<textarea id="c" style="width: 100%">

</textarea>
<script>


var commentFlag = [
    [/\\#if/gm , 'AMS_IF_COMMENT' , '\\#if'],
    [/\\#elseif/gm , 'AMS_ELSEIF_COMMENT' , '\\#elseif'],
    [/\\#else/gm , 'AMS_ELSE_COMMENT' , '\\#else'],
    [/\\#each/gm , 'AMS_EACH_COMMENT' , '\\#each'],
    [/\\#end/gm , 'AMS_END_COMMENT' , '\\#end'],
    [/\\#var/gm , 'AMS_VAR_COMMENT' , '\\#var'],
    [/\\#js/gm , 'AMS_JS_COMMENT' , '\\#js']
];


function temporaryProtection(value) {

    commentFlag.forEach(function (o) {
        value = value.replace(o[0], o[1])
    });

    //转换JS代码块
    value = value.replace(/#js([\s\S]*?)#end/gm, 'AMS_FLAG_JS$1AMS_FLAG_ENDJS');

    return value
}

//替换#if  #end 之间的elseif 和 #else
function replaceElse(str) {

    str = str.replace(/#(elseif)[\s]*(\([^)]+\)){1}/gm, 'AMS_FLAG_ELSEIF$2');
    str = str.replace(/#else/gm, 'AMS_FLAG_ELSE');
    //Revert TEMPBLOCK
    str = str.replace(/AMSTEMPBLOCKS==(.*)==/gm, '\\#$1');
    return str;
}

//RegExp object does not support lookbehind
//so with the code below
function translateIF(value) {

    var IFANDEACH = /(#if|#each)(\s*\(.+\)){1}/gm;

    //首先
    value = temporaryProtection(value);

    var tempValue = value;

    function _translateIf() {
        var allIf = tempValue.match(IFANDEACH);

        if (!allIf) return;

        //query first #if
        var point = tempValue.indexOf(allIf[0]);

        //as the starting point of the first interception string
        tempValue = tempValue.substring(point + allIf[0].length);

        //find the #end last place
        var current = tempValue.match(/[\s\S]*?(#end){1}/);

        //if you find the "#end"
        if (current) {
            //and  can not contain the "#if #each..."
            var matchIF = current[0].match(IFANDEACH);
            //如果片段中不再包含IF。。 或者为注释形态的IF。。，则表示为预期的片段
            if (!matchIF) {
                //if not found,it proved to be correct
                var a = allIf[0].match(IFANDEACH);
                var _a = '', _b = '';

                //replaced the a full-width in order to avoid duplication find
                if (RegExp.$1 === '#if') {
                    _a = 'AMS_FLAG_IF';
                    _b = 'AMS_FLAG_ENDIF'
                } else if (RegExp.$1 == '#each') {
                    _a = 'AMS_FLAG_EACH';
                    _b = 'AMS_FLAG_ENDEACH'
                } else if (RegExp.$1 == '#js') {
                    _a = 'AMS_FLAG_JS';
                    _b = 'AMS_FLAG_ENDJS'
                }

                var replaceStr = _a + RegExp.$2 + current[0].substring(0, current[0].lastIndexOf('#end')) + _b;
                if (RegExp.$1 === '#if') replaceStr = replaceElse(replaceStr);
                //Find if  else  end
                value = value.replace(allIf[0] + current[0], replaceStr);
                //repeat find
                tempValue = value;
            }
        }

        _translateIf();
    }


    _translateIf();

    //接下来分析模板
    function replaceEcho(_value) {
        var re = /[\\]+#\{([^}]+)\}/gm;
        value = _value.replace(re, '{{AmsVariableCommentStart--$1--AmsVariableCommentEnd');
        value = value.replace(/#\{([^}]+)\}/gm, '{{AmsVariableStart--$1--AmsVariableEnd}}')
    }

    replaceEcho(value);

    return value;
}

//寻找变量值
function transportOperation(value) {

    var re = /(AMS_FLAG_IF|AMS_FLAG_ELSEIF|AMS_FLAG_EACH){1}(.*?)(?=AMS_FLAG_ELSEIF|AMS_FLAG_ELSE|AMS_FLAG_ENDIF|[\r\n])/gm;

    value = value.replace(re, '$1AMS_OPERATION--$2--AMS_OPERATION');

    //开始逐一判断参数合法性

    var amsOperation = /AMS_OPERATION--(.*?)--AMS_OPERATION/gm;

    var operation = value.match(amsOperation);
    //首先靠猜测
    if (operation) {
        operation.forEach(function (item) {
            var source = item.match(amsOperation);
            var $1 = RegExp.$1;
            //首先查询最右侧括号
            var rightEnd = $1.lastIndexOf(')');
            var step1 = $1.substring(0, rightEnd + 1);
            var step1End = $1.substring(rightEnd + 1);
            if (JSHINT('var test=' + step1.trim() + ';')) {
                value = value.replace('AMS_OPERATION--' + $1 + '--AMS_OPERATION', 'AMS_OPERATION_SUCCESS--' + step1 + '--AMS_OPERATION_SUCCESS' + step1End);
            } else {
                var _step1 = step1;
                var i = 0;
                var length = step1.length;
                while (_step1.length > 1) {
                    if (JSHINT('var test=' + _step1.trim() + ';')) {
                        value = value.replace('AMS_OPERATION--' + $1 + '--AMS_OPERATION', 'AMS_OPERATION_SUCCESS--' + _step1.trim() + '--AMS_OPERATION_SUCCESS' + step1.trim().substring(_step1.trim().length));
                        break;
                    }
                    _step1 = _step1.substring(0, step1.length - i);
                    if (i >= step1.length) break;
                    i++;
                }
            }
        });
    }

    return value;
}

//转换var关键字
function transportVar(value) {
    var re = /^[\s]*[\\]*#var(.*)$/gm;
    value = value.replace(/^([^\r\n\S]*?)\\([\\]*)#(var(?:.*)+)*$/gm, 'AmsVarCommentStart--$1$2#$3--AmsVarCommentEnd');
    var match = value.match(re);
    if (match) {
        match.forEach(function (str) {
            var strTrim = str.trim();
            if (strTrim.indexOf('\\') !== 0) {
                var isHasSemicolon = strTrim.substring(strTrim.length - 1) === ';';
                value = value.replace(strTrim, 'AmsVarStart--' + strTrim.substring(1) + (isHasSemicolon ? '' : ';') + '--AmsVarEnd');
            }
        });
    }

    return value;
}

//转换JS代码块
function transportJS(value) {
    var _jsRe = /AMS_FLAG_JS([\s\S]+?)AMS_FLAG_ENDJS/gm;
    var match = value.match(_jsRe)
    if (match) {
        match.forEach(function (str) {
            var v = str.match(_jsRe);
            var $1 = RegExp.$1;
            value = value.replace(str, 'AMS_FLAG_JS' + encodeURIComponent($1) + 'AMS_FLAG_ENDJS');
        });
    }
    return value;
}

document.getElementById('test').onkeydown = function () {
    var self = this;
    setTimeout(function () {
        var value = self.value;
        //document.getElementById('b').value = translateIF(self.value);
        document.getElementById('b').value = translateIF(self.value);
        var c = document.getElementById('c');
        var bValue = document.getElementById('b').value;
        var html = [];

        //首先捕获JS代码区域
        bValue = transportJS(bValue);
        //捕获#IF  #EACH后方的变量，并判断正确性
        bValue = transportOperation(bValue);
        //捕获变量声明
        bValue = transportVar(bValue);

        if (/AMS_OPERATION--/gm.test(bValue)) {
            alert('语法不正确，请检查');
            return;
        } else {
            c.value = bValue;
        }

        //开始转换为JS
        bValue.split(/[\r\n]/).forEach(function (str2) {

            //检查IF标签配对
            var OPEN_IF = [
                'AMS_FLAG_IFAMS_OPERATION_SUCCESS',
                'AMS_FLAG_ELSEIFAMS_OPERATION_SUCCESS',
                'AMS_FLAG_ELSE',
                'AMS_FLAG_ENDIF'
            ];

            var CLOSE_IF = 'AMS_OPERATION_SUCCESS';
            var IF_FLAG = new RegExp('' +
                    '(' +
                    OPEN_IF[0] + '--(?:.+?)--' + CLOSE_IF + '|' +
                    OPEN_IF[1] + '--(?:.+?)--' + CLOSE_IF + '|' +
                    'AMS_FLAG_ELSE|AMS_FLAG_ENDIF)', 'gmi');

            //检查Each标签配对
            str2.split(IF_FLAG).forEach(function (str, i, arr) {
                if (IF_FLAG.test(str)) {
                    if (/AMS_FLAG_IFAMS_OPERATION_SUCCESS/.test(str)) {
                        html.push(str.replace(/AMS_FLAG_IFAMS_OPERATION_SUCCESS--(.*?)--AMS_OPERATION_SUCCESS/g, 'if $1 {'));
                    } else if (/AMS_FLAG_ELSEIFAMS_OPERATION_SUCCESS/.test(str)) {
                        html.push(str.replace(/AMS_FLAG_ELSEIFAMS_OPERATION_SUCCESS--(.*?)--AMS_OPERATION_SUCCESS/, '} else if $1 { '));
                    }
                    if (str === 'AMS_FLAG_ELSE') {
                        html.push(str.replace(/AMS_FLAG_ELSE/, '} else {'));
                    }
                    if (str === 'AMS_FLAG_ENDIF') {
                        html.push(str.replace(/AMS_FLAG_ENDIF/gm, '}'));
                    }
                } else {
                    html.push('AMS_RENDER.push("' + str + '")');
                }
                html.push('\r\n');
                if (i === arr.length - 1) html.push('AMS_RENDER.push("\\r\\n");');
            });
            html.push('\r\n');
        });

        c.value = html.join('');

    }, 0);
};

window.onload = function () {
    setTimeout(function () {
        document.getElementById('b').value = document.getElementById('test').value;
    }, 0);
};

</script>
</body>
</html>
