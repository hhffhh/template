<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Analysis label pairing</title>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        pre, textarea {
            display: inline-block;
            width: 31%;
            vertical-align: top;
            height: 1200px;
            border: solid 1px #aaa;
            background: #333;
            color: #fff;
            padding: 1em;
            margin: 0;
            font-family: Consolas, sans-serif;
            font-size: 12px;
        }
    </style>
</head>
<body>
<h1>Analysis label pairing</h1>

<h2>Support #if|#each and #end</h2>

<p></p>
<textarea id="test" cols="60" rows="10">
    #if(a>0) hahahah #elseif(a<0) yes #elseif(2>0) yes2 #else no default @end

    #if(test>2)
    <li>hello world</li>
    #end

    #each(customList)
    <li>姓名：#{name} 年龄：#{age} 身高:#{height}</li>
    #end

    #var arr=[123,333,4444,5555]

    #each(arr)
    <li>#{ item + ':' + (index+1) }</li>
    #end
    //http://tms.taobao.com/page/com.taobao.cms.tag.model.ImageLink@2f083c94?spm=0.0.0.1.unGWBE

    //暂时不支持遍历对象
</textarea>
<textarea id="b">

</textarea>

<textarea id="c">

</textarea>
<script>

    var IFANDEACH = /([\\]*#if|[\\]*#each)([\s]*\([^#]*\))?/gm;

    //RegExp object does not support lookbehind
    //so with the code below
    function translateIF(value) {
        var tempValue = value;

        function _translateIf() {
            var allIf = tempValue.match(IFANDEACH);

            if (!allIf) {
                return;
            }
            //query first #if
            var point = tempValue.indexOf(allIf[0]);

            //check for escape
            var isEscape = tempValue.substring(point).indexOf('\\') === 0;

            //as the starting point of the first interception string
            tempValue = tempValue.substring(point + allIf[0].length);

            if (isEscape) {
                _translateIf();
                return;
            }

            //find the #end last place
            var current = tempValue.match(/[\s\S]*?([^\\]#end){1}/);

            //if you find the "#end"
            if (current) {
                //and  can not contain the "#if #each..."
                var matchIF = current[0].match(IFANDEACH);
                if ((!matchIF || (matchIF[0] && matchIF[0].indexOf('\\') === 0))) {
                    //if not found,it proved to be correct
                    var a = allIf[0].match(IFANDEACH);
                    var _a = '', _b = '';

                    //replaced the a full-width in order to avoid duplication find
                    if (RegExp.$1 === '#if') {
                        _a = '＃ＩＦ';
                        _b = '＃ＥＮＤＩＦ'
                    } else if (RegExp.$1 == '#each') {
                        _a = '＃ＥＡＣＨ';
                        _b = '＃ＥＮＤＥＡＣＨ'
                    } else if (RegExp.$1 == '#js') {
                        _a = '＃ＪＳ';
                        _b = '＃ＥＮＤＪＳ'
                    }

                    var replaceStr = _a + RegExp.$2 + current[0].substring(0, current[0].lastIndexOf('#end')) + _b;
                    if (RegExp.$1 === '#if') replaceStr = replaceElse(replaceStr);
                    //Find if  else  end
                    value = value.replace(allIf[0] + current[0], replaceStr);
                    //repeat find
                    tempValue = value;
                }
            }

            _translateIf();
        }

        var elseRule = /([\\]*#elseif|[\\]*#else[\s]){1}(\([^)]+\))*/gm;

        //替换#if #end之间的#else  #elseif
        function replaceElse(str) {
            str = str.replace(/\\#(elseif|else){1}/gm, 'AMSTEMPBLOCKS==$1==');
            str = str.replace(/#(elseif)[\s]*(\([^)]+\)){1}/gm, '＃ＥＬＳＥＩＦ$2');
            str = str.replace(/#else/gm, '＃ＥＬＳＥ');
            //Revert TEMPBLOCK
            str = str.replace(/AMSTEMPBLOCKS==(.*)==/gm, '\\#$1');
            return str;
        }

        _translateIf();

        //接下来分析模板
        function replaceEcho(_value) {
            var re = /[\\]+#\{([^}]+)\}/gm;
            value = _value.replace(re, '{{AmsVariableCommentStart--$1--AmsVariableCommentEnd');
            value = value.replace(/#\{([^}]+)\}/gm, '{{AmsVariableStart--$1--AmsVariableEnd}}')
        }

        replaceEcho(value);

        return value;
    }

    document.getElementById('test').onkeydown = function () {
        var self = this;
        setTimeout(function () {
            var value = self.value;
            //document.getElementById('b').value = translateIF(self.value);
            document.getElementById('b').value = translateIF(self.value);
            var c = document.getElementById('c');
            var bValue = document.getElementById('b').value;
            var html = [];
            var rule = /(＃ＩＦ|＃ＥＬＳＥ(?:ＩＦ)*|＃ＥＮＤＩＦ|＃ＥＡＣＨ|＃ＥＮＤＥＡＣＨ)[\s]*(?:\((.*)\))*/gm;
            bValue.split(/[\r\n]/).forEach(function (str) {
                if (rule.test(str)) {
                    switch (RegExp.$1) {
                        case "＃ＩＦ":
                            html.push('if (' + RegExp.$2 + '){');
                            break;
                        case "＃ＥＬＳＥＩＦ":
                            html.push('}else if(' + RegExp.$2 + '){');
                            break;
                        case "＃ＥＬＳＥ":
                            html.push('}else{');
                            break;
                        case "＃ＥＮＤＩＦ":
                            html.push('}');
                            break;
                        case "＃ＥＡＣＨ":

                            html.push(RegExp.$2 + '.forEach(function(item,index){');
                            break;
                        case "＃ＥＮＤＥＡＣＨ":
                            html.push('})');
                            break;
                    }
                } else {
                    html.push('tpl.push("' + str + '");');
                }
            });

            c.value = html.join('\r\n');

        }, 0);
    };

    window.onload = function () {
        setTimeout(function () {
            document.getElementById('b').value = document.getElementById('test').value;
        }, 0);
    };

</script>
</body>
</html>
